name: Build immortalwrt Firmware (è±†åŒ…)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target platform'
        required: true
        type: choice
        options:
          - rockchip
      subtarget:
        description: 'Subtarget/Chip'
        required: true
        type: choice
        options:
          - rk3568
      device:
        description: 'Device name'
        required: true
        type: choice
        options:
          - nanopi-r5s
      config_url:
        description: 'å…¬å¼€å¯è®¿é—®çš„ .config æ–‡ä»¶ URL (å¿…é¡»ä»¥ http æˆ– https å¼€å¤´)'
        required: true
        default: 'https://raw.githubusercontent.com/ctowl/im_action/refs/heads/main/custom/nanopi-r5s.config'

jobs:
  prepare:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    outputs:
      tag_name: ${{ steps.tag.outputs.TAG_NAME }}

    steps:
      - name: Checkout immortalwrt source
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: master

      - name: Init build environment
        run: |
          sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'

      - name: Download custom .config
        run: |
          wget -O .config "${{ github.event.inputs.config_url }}"
          make defconfig

      - name: Save workspace as artifact
        run: |
          # åªä¿å­˜å¿…è¦çš„æ–‡ä»¶å’Œç›®å½•ï¼Œæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶
          tar -czf workspace.tar.gz --warning=no-file-changed \
            .config Makefile include scripts target package feeds tools toolchain \
            --exclude=target/linux/generic \
            --exclude=target/linux/rockchip \
            --exclude=package/feeds \
            --exclude=toolchain/build_dir \
            --exclude=tools/build_dir
      - uses: actions/upload-artifact@v4
        with:
          name: build-workspace
          path: workspace.tar.gz
          retention-days: 1

      - name: Create tag name
        id: tag
        run: |
          echo "TAG_NAME=immortalwrt-$(date +%Y%m%d)-${{ github.event.inputs.device }}" >> $GITHUB_ENV
          echo "TAG_NAME=immortalwrt-$(date +%Y%m%d)-${{ github.event.inputs.device }}" >> $GITHUB_OUTPUT

      - name: Clean up workspace
        if: always()
        run: |
          sudo rm -rf workspace.tar.gz

  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    needs: prepare

    steps:
      - name: Init build environment
        run: |
          sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'

      - name: Download workspace
        uses: actions/download-artifact@v4
        with:
          name: build-workspace
          path: ./immortalwrt

      - name: Extract workspace
        run: |
          cd immortalwrt
          tar -xzf workspace.tar.gz
          rm workspace.tar.gz  # ç«‹å³åˆ é™¤ä¸å†éœ€è¦çš„å‹ç¼©åŒ…

      - name: Build firmware
        run: |
          cd immortalwrt
          make -j$(nproc) || make -j1 V=s

      - name: Clean up unnecessary build files
        run: |
          cd immortalwrt
          # åˆ é™¤ç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜
          make clean
          # åˆ é™¤ä¸éœ€è¦çš„å·¥å…·é“¾å’Œå·¥å…·æ„å»ºç›®å½•
          sudo rm -rf toolchain/build_dir
          sudo rm -rf tools/build_dir
          # åˆ é™¤å†…æ ¸æºä»£ç ä»¥èŠ‚çœç©ºé—´
          sudo rm -rf target/linux/generic
          sudo rm -rf target/linux/${{ github.event.inputs.target }}

      - name: Package firmware
        run: |
          mkdir -p output
          cp -r immortalwrt/bin/targets/*/* output/
          # ä½¿ç”¨æ›´é«˜æ•ˆçš„å‹ç¼©å‚æ•°
          cd output && zip -r -9 ../firmware.zip . && cd ..

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: firmware.zip
          retention-days: 1

      - name: Clean up workspace
        if: always()
        run: |
          sudo rm -rf immortalwrt output firmware.zip

  release:
    runs-on: ubuntu-22.04
    needs: [prepare, build]

    steps:
      - name: Download firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware
          path: .

      - name: Create GitHub release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          release_name: ${{ needs.prepare.outputs.tag_name }}
          draft: false
          prerelease: false
          body: |
            # ğŸ‰ immortalwrt å›ºä»¶å‘å¸ƒ - ${{ github.event.inputs.device }}

            - ğŸ“… æ„å»ºæ—¥æœŸï¼š**${{ needs.prepare.outputs.tag_name }}**
            - ğŸ“¦ è®¾å¤‡å‹å·ï¼š**${{ github.event.inputs.device }}**
            - ğŸ§± å¹³å°æ¶æ„ï¼š**${{ github.event.inputs.target }} / ${{ github.event.inputs.subtarget }}**
            - ğŸŒ é»˜è®¤ IPï¼š`192.168.1.1`
            - ğŸ”‘ é»˜è®¤ç”¨æˆ·åï¼š`root`
            - ğŸ”’ é»˜è®¤å¯†ç ï¼šç©ºï¼ˆé¦–æ¬¡ç™»å½•æ— éœ€å¯†ç ï¼‰

            ## ğŸ“¥ ä¸‹è½½åœ°å€

            | æ–‡ä»¶å | æè¿° |
            |--------|------|
            | `immortalwrt-${{ github.event.inputs.device }}.zip` | å›ºä»¶åŒ…ï¼ˆåŒ…æ‹¬å†…æ ¸ã€æ ¹æ–‡ä»¶ç³»ç»Ÿç­‰ï¼‰ |

            âœ¨ åŸºäº [immortalwrt å®˜æ–¹ä»“åº“](https://github.com/immortalwrt/immortalwrt) ç¼–è¯‘ã€‚

      - name: Upload firmware to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_path: firmware.zip
          asset_name: immortalwrt-${{ github.event.inputs.device }}.zip
          asset_content_type: application/zip

      - name: Clean up workspace
        if: always()
        run: |
          rm firmware.zip
